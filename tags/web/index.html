<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8" />
    <meta name="author" content="Kellen Piffner" />
    
    <meta name="description" content="Developer blogging about web technology, healthcare, and whatever else comes to mind." />
    <title>kellen.piffner.com</title>
    
    <link rel="alternative" href="/atom.xml" title="kellen.piffner.com" type="application/atom+xml">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/normalize.css" type="text/css">
    <link rel="stylesheet" href="/css/layout.css" type="text/css">
    <link rel="stylesheet" href="/css/blog.css" type="text/css">
    <!--[if lt IE 9]>
        <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <link rel="stylesheet" href="/css/ie8.css" type="text/css">
    <![endif]-->
    
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-47279370-1', 'piffner.com');
    ga('send', 'pageview');

</script>

    
</head>

<body>
    <header id="header">
    <!--[if lt IE 9]>
<div class="unsupported-browser">
    <p>This site talks about a lot of modern web technologies. As such, you're going to be missing out on a lot with this older browser.</p>
    <p>I recommend upgrading to the latest <a href="https://ie.microsoft.com/">Internet Explorer</a>, <a href="https://chrome.google.com">Google Chrome</a>, or <a href="https://mozilla.org/firefox/">Firefox</a>.</p>
    <p>If you are using IE 9 or later, make sure you <a href="http://windows.microsoft.com/en-US/windows7/webpages-look-incorrect-in-Internet-Explorer">turn off "Compatibility View"</a>.</p>
</div>
<![endif]-->

<h1><a class="brand" href="/">kellen.piffner.com</a></h1>
<div class="share-icons">
    <a class="social-symbol" title="twitter" target="_blank" href="https://twitter.com/@KellenPiffner">&#xe086;</a>
    <a class="social-symbol" title="github" target="_blank" href="https://github.com/decoy">&#xe037;</a>
    <a class="social-symbol" title="google plus" target="_blank" href="https://plus.google.com/109745187704465695599/about">&#xe039;</a>
    <a class="social-symbol" title="linkedin" target="_blank" href="http://www.linkedin.com/in/kellenpiffner">&#xe052;</a>
    <a class="social-symbol" title="blog feed" target="_blank" href="/atom.xml">&#xe071;</a>
</div>
    </header>

    
    <article class="ghost post">
    <div class="article-date">
        <p class="article-day">06</p>
        <p class="article-month">Jan 2016</p>
    </div>

    <header>

        
<h1 class="article-title"><a href="/2016/01/06/PingPongr/">Introducing PingPongr</a></h1>


    </header>

    <div class="article-entry">
        
        <p>Over the break, I wanted to build a quick nutrition web app.</p>
<p>My normal go-to framework for web applications is <a href="https://github.com/NancyFx/Nancy" target="_blank">Nancy</a>.  It&#39;s pretty lean and easy to get going, but... lately it&#39;s been feeling rather heavy.  It has a lot of features I never use (razor views, for instance), and I end up building out a good bit of bootstrap code to turn it all off and manually configure the bits I want.</p>
<p>So... what to do...</p>
<h2 id="mediatr">MediatR</h2>
<p>Recently, I discovered <a href="https://github.com/jbogard/MediatR" target="_blank">MediatR</a>.  At its simplest, it sends a request through a handler that returns a response.</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">class</span> Ping : IRequest&lt;<span class="keyword">string</span>&gt; { }

<span class="keyword">public</span> <span class="keyword">class</span> PingHandler : IRequestHandler&lt;Ping, <span class="keyword">string</span>&gt; {
    <span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Handle</span>(Ping request) {
        <span class="keyword">return</span> <span class="string">"Pong"</span>;
    }
}
</pre></td></tr></table></figure>

<p>You use the above handler like so:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
</pre></td><td class="code"><pre><span class="keyword">var</span> pong = mediator.Send(<span class="keyword">new</span> Ping());  <span class="comment">//returns "Pong"</span>
</pre></td></tr></table></figure>

<p>What&#39;s interesting about MediatR is all the configuration magic happens at your IoC container.  Handlers are generated by the container, injecting any dependencies.  The request and response objects never have to know anything about the handler in-between.</p>
<p>And infrastructure and other concerns can be moved to decorators that your original code never has to know about:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="keyword">public</span> <span class="keyword">class</span> LoggingDecorator&lt;TRequest, TResponse&gt;
    : IRequestHandler&lt;TRequest, TResponse&gt;
    <span class="keyword">where</span> TRequest : IRequest&lt;TResponse&gt;
{
    IRequestHandler&lt;TRequest, TResponse&gt; inner;
    <span class="keyword">public</span> <span class="title">LoggingDecorator</span>(IRouteRequestHandler&lt;TRequest, TResponse&gt; inner)
    {
        <span class="keyword">this</span>.inner = inner;
    }

    <span class="keyword">public</span> TResponse <span class="title">Handle</span>(TRequest message)
    {
        <span class="keyword">var</span> sw = Stopwatch.StartNew();
        <span class="keyword">var</span> results = <span class="keyword">this</span>.inner.Handle(message, cancellationToken);
        sw.Stop();

        Console.WriteLine(String.Format(<span class="string">"Processed {0} in {1}ms"</span>, message.ToString(), sw.ElapsedMilliseconds));

        <span class="keyword">return</span> results;
    }
}
</pre></td></tr></table></figure>

<p>Handlers like the above LoggingDecorator can &#39;decorate&#39; handlers, wrapping them  for all sorts of things - validations, logging, authorizations, etc.</p>
<p>I won&#39;t go much more into this, but check out Jimmy Bogard&#39;s blog post  <a href="https://lostechies.com/jimmybogard/2014/09/09/tackling-cross-cutting-concerns-with-a-mediator-pipeline/" target="_blank">&quot;Tackling cross-cutting concerns with a mediator pipeline&quot;</a> for more information on using this pattern.</p>
<h2 id="owin">Owin</h2>
<p>After using MediatR for a bit, I realized that it covered the majority of what I wanted a web framework to do.  It sent requests, handled them, and returned responses.  It was just missing the &#39;web&#39; part.  How hard could it be, right?  Surprisingly, it turns out to be not really all that hard.</p>
<p>You&#39;ve probably heard of &quot;Owin&quot;, but might not know anything about it other than it&#39;s &#39;the next thing!&#39; or slightly more useful, it&#39;s an <a href="http://owin.org/" target="_blank">&quot;Open Web Interface for .NET&quot;</a>.</p>
<p>If you&#39;ve worked with nodejs for a web app, you&#39;re probably familiar with their middleware layers.  It allows you to process an HTTP request through a pipeline,  where each &#39;layer&#39; can do whatever it needs to with the request - respond, log, etc. - all in a standardized way.  Owin brings that to .NET.  And combined with  async/await, it&#39;s quite easy to create your own middleware.</p>
<p>The quickest way to get going with Owin is to use the Microsoft&#39;s Owin nuget packages.  They provide a light layer on top of the base Owin requests api and server packages.  Here&#39;s an empty, self hosted web server:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="keyword">using</span> Owin;
<span class="keyword">using</span> System;

<span class="keyword">public</span> <span class="keyword">class</span> Program
{
    <span class="keyword">public</span> <span class="keyword">class</span> Startup
    {
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configuration</span>(IAppBuilder app)
        {
        }
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="keyword">string</span>[] args)
    {
        <span class="keyword">var</span> url = <span class="string">"http://localhost:12345"</span>;

        <span class="keyword">using</span> (Microsoft.Owin.Hosting.WebApp.Start&lt;Startup&gt;(url))
        {
            Console.WriteLine(<span class="string">"Listening at "</span> + url);
            Console.ReadLine();
        }
    }
}
</pre></td></tr></table></figure>

<p>If you run this example, you&#39;ll see it doesn&#39;t really do anything.  Any request you run against the server will just come back 404 not found.</p>
<p>So, let&#39;s add something to the Configuration function:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
</pre></td><td class="code"><pre>app.Use<span class="function"><span class="params">(async (context, next) =&gt;
{
   Console.WriteLine(<span class="string">"Something is happening!"</span>);
   await next();
})</span>;</span>
</pre></td></tr></table></figure>

<p>Now if you run the example and request something against the server, you&#39;ll still get 404, but you&#39;ll also get that console message.  You&#39;ve successfully created your first Owin middleware!</p>
<p>So... what&#39;s going on?</p>
<p>The app.Use call is defining an async function that runs when a request comes in.  Each request will go through that function.  You can have multiple &#39;Use&#39; functions that are called in order when a request comes in, with each one calling the &quot;next()&quot; function in the pipeline.  The context passed contains the information about the request - the headers, the content and response streams - all the normal things you&#39;d expect from a web request.</p>
<p>Let&#39;s add another, more complicated middleware that actually does something:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="code"><pre>app.Use<span class="function"><span class="params">(async (context, next) =&gt;
{
    <span class="keyword">if</span> (context.Request.Path.StartsWithSegments(<span class="keyword">new</span> PathString(<span class="string">"/hello"</span>)))
    {
        using (<span class="reserved">var</span> writer = <span class="keyword">new</span> System.IO.StreamWriter(context.Response.Body))
        {
            await writer.WriteLineAsync(<span class="string">"Hello!"</span>);
        }
        context.Response.StatusCode = <span class="number">200</span>;
    }
    await next();
})</span>;</span>
</pre></td></tr></table></figure>

<p>If you load up &quot;/hello&quot; in a browser, you should now see &quot;Hello!&quot;, while you&#39;ll still see your earlier console message.</p>
<h2 id="pingpongr">PingPongr</h2>
<p>That brings me to <a href="https://github.com/decoy/PingPongr" target="_blank">PingPongr</a>, the product of all this discovery.</p>
<p>The PingPongr nuget package has only one dependency: the core Owin package.</p>
<p>Here&#39;s an example API that should look pretty familiar after seeing the earlier mediator code:</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="keyword">using</span> PingPongr;
<span class="keyword">using</span> System.Threading;
<span class="keyword">using</span> System.Threading.Tasks;

<span class="comment">//A request is unique per route</span>
<span class="keyword">public</span> <span class="keyword">class</span> Ping : IRouteRequest&lt;Pong&gt;
{
    <span class="keyword">public</span> <span class="keyword">string</span> Hi { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}

<span class="comment">//responses can be shared between routes</span>
<span class="keyword">public</span> <span class="keyword">class</span> Pong
{
    <span class="keyword">public</span> <span class="keyword">string</span> Reply { <span class="keyword">get</span>; <span class="keyword">set</span>; }
}

<span class="keyword">public</span> <span class="keyword">class</span> PingHandler : IRouteRequestHandler&lt;Ping, Pong&gt;
{
    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Pong&gt; <span class="title">Handle</span>(Ping message, CancellationToken cancellationToken)
    {
        <span class="keyword">return</span> <span class="keyword">await</span> DoSomethingCoolAsync();
    }
}
</pre></td></tr></table></figure>

<p>And finally, a functional, self hosted example using SimpleInjector for the container.</p>
<figure class="highlight C#"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="keyword">using</span> Owin;
<span class="keyword">using</span> PingPongr;
<span class="keyword">using</span> PingPongr.OwinSupport;
<span class="keyword">using</span> SimpleInjector;
<span class="keyword">using</span> System;

<span class="keyword">public</span> <span class="keyword">class</span> Program
{
    <span class="keyword">public</span> <span class="keyword">class</span> Startup
    {
        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configuration</span>(IAppBuilder app)
        {
            <span class="comment">//setup the container</span>
            <span class="keyword">var</span> container = <span class="keyword">new</span> Container();
            <span class="keyword">var</span> assemblies = <span class="keyword">new</span>[] { <span class="keyword">typeof</span>(Program).Assembly };

            <span class="comment">//register all the route request handlers</span>
            container.Register(<span class="keyword">typeof</span>(IRouteRequestHandler&lt;,&gt;), assemblies);

            container.Verify();

            <span class="comment">//an instance factory is how request handlers are built from the container.</span>
            <span class="keyword">var</span> factory = <span class="keyword">new</span> InstanceFactory(container.GetInstance);

            <span class="comment">//the lib comes with a json media handler built with SimpleJson</span>
            <span class="keyword">var</span> mediaHandlers = <span class="keyword">new</span>[] { <span class="keyword">new</span> DefaultJsonMediaHandler() };

            <span class="comment">//the routes are found using reflection via the RouteBuilder</span>
            <span class="keyword">var</span> routes = RouteBuilder.WithAssemblies(assemblies).GetRoutes();
            <span class="keyword">foreach</span> (<span class="keyword">var</span> r <span class="keyword">in</span> routes) Console.WriteLine(r.Path);

            <span class="comment">//setup the PingPongr router</span>
            <span class="comment">//(Note: we're setting this up manually, but it could be created by the container)</span>
            IRouter router = <span class="keyword">new</span> Router(
                routes,
                mediaHandlers,
                factory
                );

            app.UsePingPongr(router);
        }
    }

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="keyword">string</span>[] args)
    {
        <span class="keyword">using</span> (Microsoft.Owin.Hosting.WebApp.Start&lt;Startup&gt;(<span class="string">"http://localhost:12345"</span>))
        {
            Console.ReadLine();
        }
    }
}
</pre></td></tr></table></figure>

<p>A few things to note:</p>
<ul>
<li>The InstanceFactory works exactly like MediatR&#39;s SingleInstanceFactory, so the container examples from the MediatR project can be used directly.</li>
<li>The RouteBuilder object does a bit of reflection to discover possible routes (IRouteRequests) and cache them for use in the router.</li>
<li>Any HTTP method is accepted on a matching route.  Route matching is strictly by the path.</li>
<li>All handlers are async.  Welcome to the future ;).</li>
</ul>
<p>Over all, the library ended up quite lean and an easy read if you&#39;re curious about the inner workings.  The Tests and Sandbox example projects should also help.</p>
<h4 id="future">Future</h4>
<p>The package is still currently marked as pre-release until it&#39;s seen some real world use.  At the very least, the default JSON implementation needs some tweaks to check a broader range of request media types.</p>
<p>At some point I&#39;d also like to build a standard TCP/IP server for the library as an alternative to Owin making the library even more useful for inter-process communication for micro-services.</p>
<p>My hope is to keep the core library very lean, though.  The less it&#39;s doing, with the least amount of magic, the more maintainable it is for me (and you) to use in projects in the long run.</p>
<p>Oh, also in the future, I hope to complete that nutrition app I talked about...</p>

        
    </div>

    <footer>
        <div class="article-tags">
            
Tags:
  
<a href='/tags/web/' class="article-tag">web</a>
  
<a href='/tags/PingPongr/' class="article-tag">PingPongr</a>
  
<a href='/tags/Owin/' class="article-tag">Owin</a>
  
<a href='/tags/DotNet/' class="article-tag">DotNet</a>
  

        </div>
        
        
    </footer>
</article>



    <article class="ghost post">
    <div class="article-date">
        <p class="article-day">22</p>
        <p class="article-month">Feb 2014</p>
    </div>

    <header>

        
<h1 class="article-title"><a href="/2014/02/22/monty-hall-puzzle/">Monty Hall Puzzle</a></h1>


    </header>

    <div class="article-entry">
        
        <p>Wikipedia has an excellent article on the “probability puzzle” know as the Monty Hall problem.  </p>
<blockquote>
<p><a href="http://en.wikipedia.org/wiki/Monty_Hall_problem" target="_blank">http://en.wikipedia.org/wiki/Monty_Hall_problem</a></p>
</blockquote>
<p>It’s based around the concept of a game show where a contestant must pick one of three doors.  Behind one of the doors is the prize.  When the contestant picks the door, the host opens one of the other doors that doesn’t have the prize and then asks the contestant if they want to switch their choice.  The question: Do you switch or not? </p>
<blockquote>
<img src="/img/montyhall1.png" title="Goat">


</blockquote>
<p>At first, most people guess that it doesn’t matter.  There are two closed doors, so your chance must be 1:2 to guess correctly, right?  The correct answer:  You should always switch.</p>
<h2 id="simulation">Simulation</h2>
<p>For some reason, instead of reading through the rest of the Wikipedia article, I decided I needed to recreate this simulation in javascript (of course), so you can play along.</p>
<p>First, here’s the game. It will track when you switch doors and when you don’t and spit out your winning stats.  You can also press the &quot;Simulate&quot; button to automatically &quot;play&quot; the game so you can see the odds of winning for yourself.</p>
<p>Try it yourself:</p>
<p><p data-height="550" data-theme-id="4105" data-slug-hash="qdkFp" data-default-tab="result" class='codepen'>See the Pen <a href='http://codepen.io/decoyahoy/pen/qdkFp'>Monty Hall Problem simulator</a> by kp (<a href='http://codepen.io/decoyahoy'>@decoyahoy</a>) on <a href='http://codepen.io'>CodePen</a>.</p></p>
<script async src="//codepen.io/assets/embed/ei.js"></script>

<p>You can see that when simulating play, the odds roughly come out to be 1:3 when staying, and 2:3 when switching doors.</p>
<img src="/img/montyhall2.png" >


<h2 id="different-way-of-thinking">Different way of thinking</h2>
<p>For me, breaking a concept down in order to turn it into a program often helps me see that concept differently.</p>
<p>In this case, after building the program I realized that you can think of the switch as getting to pick two doors instead of just the one.  You’re picking the door you <em>don’t</em> want to open.</p>
<p>You can enable that behavior instead by choosing the game mode &quot;Open Others&quot; at the bottom.  Every play is the equivalent of “open both doors that aren’t this one.”  You can also flip the switch to &quot;Open Selected&quot; to change the behavior to the opposite: where the door you pick is the one that’s opened.</p>
<p>You can also change the number of total doors.  If you set it to something like 20 (where your odds are now 1:20 for staying and 19:20 for switching) it might help visualize the what&#39;s going on here.  Here&#39;s a quote from Marilyn vos Savant from that Wikipedia article.</p>
<blockquote>
<p>Yes; you should switch. The first door has a 1/3 chance of winning, but the second door has a 2/3 chance. Here&#39;s a good way to visualize what happened. Suppose there are a million doors, and you pick door #1. Then the host, who knows what&#39;s behind the doors and will always avoid the one with the prize, opens them all except door #777,777. You&#39;d switch to that door pretty fast, wouldn&#39;t you?</p>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<p>There are many other simulations of this puzzle out there (and youtube videos, articles, dance interpretations, etc...), but hopefully the code sample is useful to someone, or someone learned something new.</p>
<p>For me, it was a fun way to spend a few hours playing with <a href="http://codepen.io" target="_blank">http://codepen.io</a> trying to make a ‘door’ animation in CSS.</p>
<p>One thing to note: I wrote the front end in <a href="http://angularjs.org/ Angularj" target="_blank">AngularJS</a>.  I&#39;ll blog about that more later, but using the framework easily halved the code necessary to display the UI.</p>
<p>For some more reading about the css doors:
<a href="http://24ways.org/2010/intro-to-css-3d-transforms/" target="_blank">http://24ways.org/2010/intro-to-css-3d-transforms/</a></p>
<p>Cheers!</p>

        
    </div>

    <footer>
        <div class="article-tags">
            
Tags:
  
<a href='/tags/javascript/' class="article-tag">javascript</a>
  
<a href='/tags/css3/' class="article-tag">css3</a>
  
<a href='/tags/angularjs/' class="article-tag">angularjs</a>
  
<a href='/tags/web/' class="article-tag">web</a>
  
<a href='/tags/codepen/' class="article-tag">codepen</a>
  

        </div>
        
        
    </footer>
</article>



    <article class="ghost post">
    <div class="article-date">
        <p class="article-day">31</p>
        <p class="article-month">Jan 2014</p>
    </div>

    <header>

        
<h1 class="article-title"><a href="/2014/01/31/basic-animation/">Basic Animation</a></h1>


    </header>

    <div class="article-entry">
        
        <p>In my day job, I spend a lot of time coding core business logic applications.  What do you do with data A in situation B kind of logic.  So when I work on something code related in my off time, I like to putz with technologies outside of that bubble.</p>
<p>With that in mind, I&#39;m going to talk about animation.</p>
<h2 id="old-school">Old School</h2>
<p>Back in &quot;the day&quot;, many games just updated as fast as the CPU could.  If you loaded the same game on a faster computer, everything would move faster.  This could result in fun times likes a typing game where the game&#39;s &quot;40 words per minute&quot; was closer to 120. (I regularly scored 14!)</p>
<p>You can end up with this same problem by being &#39;frame rate dependent&#39; with your animations.  Basically, this means that you update the position of your objects at the same time that you draw the object.</p>
<p>Here&#39;s an example running 10fps, 30fps, and 60fps while drawing a simple animation:</p>
<p><p data-height="175" data-theme-id="4105" data-slug-hash="LHgbm" data-default-tab="result" class='codepen'>See the Pen <a href='http://codepen.io/decoyahoy/pen/LHgbm'>frame based animation</a> by kp (<a href='http://codepen.io/decoyahoy'>@decoyahoy</a>) on <a href='http://codepen.io'>CodePen</a>.</p></p>
<script async src="//codepen.io/assets/embed/ei.js"></script>

<p>The ball object handles the &#39;bounce&#39; effect.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="function"><span class="keyword">function</span> <span class="title">Ball</span><span class="params">(w, h)</span> {</span>

  <span class="comment">//let's just set this to 10 for now</span>
  <span class="keyword">this</span>.size = <span class="number">10</span>;

  <span class="comment">//initial ball positions</span>
  <span class="keyword">this</span>.x = <span class="number">0</span>;
  <span class="keyword">this</span>.y = <span class="number">0</span>;

  <span class="comment">//this is the expected change per direction per update</span>
  <span class="keyword">this</span>.dx = <span class="number">0.3</span>;
  <span class="keyword">this</span>.dy = <span class="number">2.75</span>;

  <span class="comment">//bounding box (can't escape)</span>
  <span class="keyword">this</span>.w = w;
  <span class="keyword">this</span>.h = h;
};

Ball.prototype.update = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
  <span class="comment">//update the ball position</span>
  <span class="keyword">this</span>.x += <span class="keyword">this</span>.dx;
  <span class="keyword">this</span>.y += <span class="keyword">this</span>.dy;

  <span class="comment">//check to see if the ball is still in bounds</span>
  <span class="comment">//if it's not, change its direction to the opposite</span>
  <span class="keyword">if</span> (<span class="keyword">this</span>.x &lt;= <span class="number">0</span> || <span class="keyword">this</span>.x &gt;= <span class="keyword">this</span>.w - <span class="keyword">this</span>.size)
    <span class="keyword">this</span>.dx = -<span class="keyword">this</span>.dx;

  <span class="keyword">if</span> (<span class="keyword">this</span>.y &lt;= <span class="number">0</span> || <span class="keyword">this</span>.y &gt;= <span class="keyword">this</span>.h - <span class="keyword">this</span>.size)
    <span class="keyword">this</span>.dy = -<span class="keyword">this</span>.dy; 
};

Ball.prototype.draw = <span class="function"><span class="keyword">function</span><span class="params">(ctx)</span> {</span>
  <span class="comment">//let's draw the ball (box) </span>
  ctx.fillRect(<span class="keyword">this</span>.x, <span class="keyword">this</span>.y, <span class="number">10</span>, <span class="number">10</span>);
};
</pre></td></tr></table></figure>

<p>In our main draw loop you can see us updating both the ball position, and then telling it to draw.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre>BallCanvas.prototype.animate = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  
  <span class="comment">//clear the canvas between frames</span>
  <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);

  <span class="comment">//update the ball position</span>
  <span class="keyword">this</span>.ball.update();

  <span class="comment">//now draw the ball</span>
  <span class="keyword">this</span>.ball.draw(<span class="keyword">this</span>.ctx);

  <span class="comment">//restart the loop after we're done updating</span>
  <span class="keyword">this</span>.start();
};

BallCanvas.prototype.start = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
  <span class="comment">//we're forcing very specific framerates here</span>
  <span class="comment">//there are better ways...</span>
  <span class="keyword">var</span> that = <span class="keyword">this</span>;
  window.setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> that.animate() }, <span class="keyword">this</span>.frameRate);
};
</pre></td></tr></table></figure>

<h2 id="better-ways">Better ways</h2>
<p>So what other options are there?  Well, you could calculate the distance the ball travels per frame by using math.  (Yay, math!)  </p>
<p>Let&#39;s assume we want the ball to update position every 10ms (100fps from the previous example).  Instead of simply updating the ball +1 on each frame, we now get the time, compare it to the previous time, and figure out how many times the ball should have moved since the last time we updated.</p>
<p>This is the new animate function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre>BallCanvas.prototype.animate = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

  <span class="comment">//get the current time</span>
  <span class="keyword">var</span> nextUpdate =  <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();

  <span class="comment">//how much time has passed (cummulative)</span>
  <span class="keyword">this</span>.elapsed += nextUpdate - <span class="keyword">this</span>.lastUpdate;

  <span class="comment">//how many updates do we need to process?</span>
  <span class="comment">//this is a little more complex than need be</span>
  <span class="comment">//so the example can keep the balls in sync</span>
  <span class="keyword">while</span> (<span class="keyword">this</span>.elapsed &gt; UPDATE_RATE) {
    <span class="comment">//update the ball position</span>
    <span class="keyword">this</span>.ball.update();
    <span class="comment">//keep track of the extra</span>
    <span class="keyword">this</span>.elapsed -= UPDATE_RATE;
  }

  <span class="comment">//clear the canvas between frames</span>
  <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);

  <span class="comment">//now draw the ball</span>
  <span class="keyword">this</span>.ball.draw(<span class="keyword">this</span>.ctx);
  
  <span class="comment">//update the update time</span>
  <span class="keyword">this</span>.lastUpdate = nextUpdate;

  <span class="comment">//restart the loop after we're done updating</span>
  <span class="keyword">this</span>.start();
};
</pre></td></tr></table></figure>

<p>And this is it running:</p>
<p><p data-height="175" data-theme-id="4105" data-slug-hash="gImtA" data-default-tab="result" class='codepen'>See the Pen <a href='http://codepen.io/decoyahoy/pen/gImtA'>frame based animation</a> by kp (<a href='http://codepen.io/decoyahoy'>@decoyahoy</a>) on <a href='http://codepen.io'>CodePen</a>.</p></p>
<script async src="//codepen.io/assets/embed/ei.js"></script>

<p>Now, the side of me that spends all day separating business logic from infrastructure code keeps asking why I&#39;m calculating positions inside of a draw loop.  Separation of concerns is a big deal in large software projects. This brings me to the next option: have a loop just for updating.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre>BallCanvas.prototype.animate = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>

  <span class="comment">//clear the canvas between frames</span>
  <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);

  <span class="comment">//now draw the ball</span>
  <span class="keyword">this</span>.ball.draw(<span class="keyword">this</span>.ctx);

  <span class="comment">//restart the loop after we're done updating</span>
  <span class="keyword">this</span>.start();
};
</pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="comment">//handle the object updates separate from drawing</span>
<span class="function"><span class="keyword">function</span> <span class="title">updateBalls</span><span class="params">()</span> {</span>
  ball10.ball.update();
  ball30.ball.update();
  ball60.ball.update();
  setTimeout(updateBalls, UPDATE_RATE);
}
</pre></td></tr></table></figure>

<p><p data-height="175" data-theme-id="4105" data-slug-hash="BfCnq" data-default-tab="result" class='codepen'>See the Pen <a href='http://codepen.io/decoyahoy/pen/BfCnq'>update loop separate from draw loops</a> by kp (<a href='http://codepen.io/decoyahoy'>@decoyahoy</a>) on <a href='http://codepen.io'>CodePen</a>.</p></p>
<script async src="//codepen.io/assets/embed/ei.js"></script>

<p>The same results, but note the math is gone, and the code is overall simpler.  This also leads to a more useful scenario of handling user input in a way where we don&#39;t have to care what&#39;s happening with the draw loop.  How about we watch the mouse cursor?</p>
<p><p data-height="175" data-theme-id="4105" data-slug-hash="daIus" data-default-tab="result" class='codepen'>See the Pen <a href='http://codepen.io/decoyahoy/pen/daIus'>follow the mouse</a> by kp (<a href='http://codepen.io/decoyahoy'>@decoyahoy</a>) on <a href='http://codepen.io'>CodePen</a>.</p></p>
<script async src="//codepen.io/assets/embed/ei.js"></script>

<p>Neat!  All we did was replace our update loop from the previous example with this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="function"><span class="keyword">function</span> <span class="title">onMouseMove</span><span class="params">(e)</span> {</span>

  <span class="comment">//get the new positions</span>
  <span class="keyword">var</span> x = e.clientX;
  <span class="keyword">var</span> y = e.clientY;

  ball10.ball.x = x;
  ball10.ball.y = y;
  ball30.ball.x = x;
  ball30.ball.y = y;
  ball60.ball.x = x;
  ball60.ball.y = y;
}

<span class="comment">//watch the mouse event</span>
document.onmousemove = onMouseMove;
</pre></td></tr></table></figure>

<h2 id="cautions">Cautions</h2>
<p>In these examples, I&#39;m using setTimeout to simulate my framerates.  Don&#39;t do this.  <code>requestAnimationFrame</code> is where it&#39;s at.</p>
<p>An excellent article on the subject:
<a href="http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/" target="_blank">http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/</a></p>
<p>Also, there are a lot of very good javascript animations libraries out there.  They have excellent framerate handling that can properly use the above requestAnimationFrame, throttle framerates on slow computers, or speed them up on fast ones.  Don&#39;t reinvent the wheel if you don&#39;t need to!</p>

        
    </div>

    <footer>
        <div class="article-tags">
            
Tags:
  
<a href='/tags/javascript/' class="article-tag">javascript</a>
  
<a href='/tags/web/' class="article-tag">web</a>
  
<a href='/tags/codepen/' class="article-tag">codepen</a>
  
<a href='/tags/animation/' class="article-tag">animation</a>
  

        </div>
        
        
    </footer>
</article>




<div class="pagination">
    
    
    <a href="/tags/web/page/2/">Older</a>
    
</div>





    
    <footer id="footer">
    <div class="share-icons">
    <a class="social-symbol" title="twitter" target="_blank" href="https://twitter.com/@KellenPiffner">&#xe086;</a>
    <a class="social-symbol" title="github" target="_blank" href="https://github.com/decoy">&#xe037;</a>
    <a class="social-symbol" title="google plus" target="_blank" href="https://plus.google.com/109745187704465695599/about">&#xe039;</a>
    <a class="social-symbol" title="linkedin" target="_blank" href="http://www.linkedin.com/in/kellenpiffner">&#xe052;</a>
    <a class="social-symbol" title="blog feed" target="_blank" href="/atom.xml">&#xe071;</a>
</div>
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script src="/js/ghost.js"></script>



  
<script type="text/javascript">
    //the tag 'cloud'
    var tags = [{"name":"hello world","path":"tags/hello world/","permalink":"http://kellen.piffner.com/tags/hello world/","slug":"hello world","length":1},{"name":"blog","path":"tags/blog/","permalink":"http://kellen.piffner.com/tags/blog/","slug":"blog","length":1},{"name":"hexo","path":"tags/hexo/","permalink":"http://kellen.piffner.com/tags/hexo/","slug":"hexo","length":1},{"name":"nodejs","path":"tags/nodejs/","permalink":"http://kellen.piffner.com/tags/nodejs/","slug":"nodejs","length":1},{"name":"javascript","path":"tags/javascript/","permalink":"http://kellen.piffner.com/tags/javascript/","slug":"javascript","length":4},{"name":"css","path":"tags/css/","permalink":"http://kellen.piffner.com/tags/css/","slug":"css","length":1},{"name":"html","path":"tags/html/","permalink":"http://kellen.piffner.com/tags/html/","slug":"html","length":1},{"name":"typescript","path":"tags/typescript/","permalink":"http://kellen.piffner.com/tags/typescript/","slug":"typescript","length":1},{"name":"microsoft","path":"tags/microsoft/","permalink":"http://kellen.piffner.com/tags/microsoft/","slug":"microsoft","length":1},{"name":"visual studio","path":"tags/visual studio/","permalink":"http://kellen.piffner.com/tags/visual studio/","slug":"visual studio","length":1},{"name":"web","path":"tags/web/","permalink":"http://kellen.piffner.com/tags/web/","slug":"web","length":4},{"name":"codepen","path":"tags/codepen/","permalink":"http://kellen.piffner.com/tags/codepen/","slug":"codepen","length":2},{"name":"animation","path":"tags/animation/","permalink":"http://kellen.piffner.com/tags/animation/","slug":"animation","length":1},{"name":"css3","path":"tags/css3/","permalink":"http://kellen.piffner.com/tags/css3/","slug":"css3","length":1},{"name":"angularjs","path":"tags/angularjs/","permalink":"http://kellen.piffner.com/tags/angularjs/","slug":"angularjs","length":1},{"name":"svn","path":"tags/svn/","permalink":"http://kellen.piffner.com/tags/svn/","slug":"svn","length":1},{"name":"development","path":"tags/development/","permalink":"http://kellen.piffner.com/tags/development/","slug":"development","length":1},{"name":"PingPongr","path":"tags/PingPongr/","permalink":"http://kellen.piffner.com/tags/PingPongr/","slug":"PingPongr","length":1},{"name":"Owin","path":"tags/Owin/","permalink":"http://kellen.piffner.com/tags/Owin/","slug":"Owin","length":1},{"name":"DotNet","path":"tags/DotNet/","permalink":"http://kellen.piffner.com/tags/DotNet/","slug":"DotNet","length":1}];
</script>





</body>
</html>
